Recording Metadata
==================

Usage Example
-------------

Metadata is bundled with the data generated by a scan. It can be used by
callbacks (e.g., to tell plots how to label their axes) or simply used to
identify and analyze the data later.

.. ipython:: python
    :suppress:

    from bluesky.standard_config import gs, ct
    from bluesky.examples import det
    gs.DETS = [det]
    gs.RE.md['beamline_id'] = 'demo'
    gs.RE.md['owner'] = 'demo'
    gs.RE.md['group'] = 'demo'
    gs.RE.md['config'] = {}

.. ipython:: python

    gs.RE.md['project'] = 'my xray project'
    gs.RE.md['sample'] = {'color': 'red', 'dimensions': [10, 20, 5]}

Or specified when the scan is run.

.. ipython:: python

    ct(experimenter='Emily', mood='excited')

.. note::

    Structured data, such as

    .. code-block:: python

        {'color': 'red', 'dimensions': [10, 20, 5]}

    is much better than a long string like

    .. code-block:: python

        'red_10_20_5'

    because it is searchable and self-describing. To encourage good practices,
    the RunEngine inists that 'sample' be a dictionary. Any other fields
    you invent can be anything you want.

Persistence Between Scans
-------------------------

The following fields are automatically reused between runs unless overridden.

* sample
* project
* owner
* group
* beamline_id
* config (which should rarely change; see below)
* scan_id (which is automatically incremented)

Custom fields, like 'experimenter' and 'mood' in the example above, are not
reused by default, as we can see below.

.. ipython:: python

    ct()
    ct(sample={'color': 'blue', 'dimensions': [3, 1, 4]})

To add a custom field to the list of peristent fields, use
``RE.persistent_fields.append('experimenter')``. Use
``RE.persistent_fields.remove('experimenter')`` to stop persisting it.
Fields that are required by our Document specification---owner, group,
beamline_id, and config---cannot be removed. (More on these below.)

To review the metadata before running ascan, check ``gs.RE.md``, which
behaves like a Python dictionary.

.. ipython:: python

    gs.RE.md['sample']

To start fresh:

.. ipython:: python

    gs.RE.md.clear()

Required Fields
---------------

Some fields and required by our Document specification, and the RunEngine will
raise a ``KeyError`` if they are not set. These fields are:

* owner
* group
* beamline_id (e.g., 'csx')
* config, a dictionary describing the hardware, calibration, dead pixels on
  detectors, etc.

``standard_config.py`` fills some of these in automatically (e.g., 'owner'
defaults to the username of the UNIX user currently logged in).
